<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baba Parfume | Ultimate Admin Panel v2</title>
    
    <!-- FONTS & ICONS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- BOOTSTRAP 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- ANIMATE CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            --secondary-gradient: linear-gradient(135deg, #3b82f6 0%, #2dd4bf 100%);
            --danger-gradient: linear-gradient(135deg, #ef4444 0%, #f43f5e 100%);
            --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --hover-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e5e7eb' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            color: #1f2937;
            padding-bottom: 80px;
        }

        /* --- NAVBAR --- */
        .navbar-custom {
            background: var(--primary-gradient);
            padding: 1rem 0;
            box-shadow: 0 4px 20px rgba(79, 70, 229, 0.2);
        }
        .navbar-brand {
            font-weight: 800;
            letter-spacing: -0.5px;
            font-size: 1.5rem;
        }
        .status-dot {
            height: 10px;
            width: 10px;
            background-color: #34d399;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 10px #34d399;
            animation: pulse 2s infinite;
        }

        /* --- CARDS & PANELS --- */
        .card-custom {
            background: var(--glass-bg);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }
        .card-custom:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }
        .card-header-custom {
            background: transparent;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 1.5rem;
            font-weight: 700;
            color: #374151;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .card-body-custom {
            padding: 1.5rem;
        }

        /* --- TABS --- */
        .nav-pills .nav-link {
            border-radius: 12px;
            padding: 12px 20px;
            font-weight: 600;
            color: #6b7280;
            background: white;
            margin: 0 5px;
            border: 1px solid transparent;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .nav-pills .nav-link.active {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
            transform: scale(1.02);
        }
        .nav-pills .nav-link:hover:not(.active) {
            background: #f9fafb;
            color: #4f46e5;
            border-color: #e5e7eb;
        }

        /* --- BUTTONS --- */
        .btn-custom {
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            position: relative;
            overflow: hidden;
        }
        .btn-primary-gradient {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
        }
        .btn-primary-gradient:hover {
            background: linear-gradient(135deg, #4338ca 0%, #6d28d9 100%);
            color: white;
            box-shadow: 0 6px 12px rgba(79, 70, 229, 0.3);
            transform: translateY(-1px);
        }
        .btn-success-gradient { background: var(--success-gradient); color: white; }
        .btn-danger-gradient { background: var(--danger-gradient); color: white; }
        .btn-action-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: 0.2s;
        }
        
        /* --- PROGRESS BARS --- */
        .progress-custom {
            height: 12px;
            border-radius: 6px;
            background-color: #e5e7eb;
            overflow: hidden;
        }
        .progress-bar-animated-custom {
            background: var(--secondary-gradient);
            background-size: 200% 200%;
            animation: gradientMove 3s ease infinite;
        }

        /* --- STATUS BADGES --- */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        .badge-idle { background-color: #f3f4f6; color: #6b7280; border: 1px solid #d1d5db; }
        .badge-running { background-color: #dcfce7; color: #15803d; border: 1px solid #86efac; animation: pulse-green 2s infinite; }
        .badge-paused { background-color: #fef9c3; color: #a16207; border: 1px solid #fde047; }
        .badge-stopped { background-color: #fee2e2; color: #b91c1c; border: 1px solid #fca5a5; }

        /* --- TABLE ENHANCEMENTS --- */
        .table-custom th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            background-color: #f9fafb;
            color: #6b7280;
            border-bottom: 2px solid #e5e7eb;
            cursor: pointer; /* For sort */
        }
        .table-custom th:hover { background-color: #f3f4f6; }
        .table-custom td {
            vertical-align: middle;
            font-size: 0.875rem;
            color: #374151;
        }
        .table-hover tbody tr:hover {
            background-color: #f9fafb;
        }
        .pagination-custom .page-link {
            border: none;
            color: #6b7280;
            margin: 0 2px;
            border-radius: 8px;
            font-weight: 500;
        }
        .pagination-custom .page-link.active {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2);
        }

        /* --- LOADER & TOAST --- */
        .loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .toast-container { z-index: 10000; }

        /* --- ANIMATIONS --- */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(52, 211, 153, 0); }
            100% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0); }
        }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
</head>
<body>

    <!-- OVERLAY LOADER -->
    <div id="globalLoader" class="loader-overlay animate__animated animate__fadeIn">
        <div class="spinner-border text-primary mb-3" style="width: 4rem; height: 4rem; border-width: 4px;" role="status"></div>
        <h4 class="fw-bold text-dark">Sedang Memproses...</h4>
        <p class="text-muted">Mohon tunggu sebentar, jangan tutup halaman ini.</p>
    </div>

    <!-- TOAST NOTIFICATION CONTAINER -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <!-- Toasts will be injected here via JS -->
    </div>

    <!-- NAVBAR -->
    <nav class="navbar navbar-custom navbar-dark sticky-top mb-4">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <i class="fa-solid fa-robot me-3 fa-lg"></i>
                <div>
                    <div>BABA PARFUME</div>
                    <div style="font-size: 0.7rem; font-weight: 400; opacity: 0.8; letter-spacing: 1px;">ULTIMATE ADMIN PANEL</div>
                </div>
            </a>
            <div class="d-flex align-items-center text-white bg-white bg-opacity-10 px-3 py-2 rounded-pill">
                <div class="status-dot me-2"></div>
                <span class="small fw-bold">System Online</span>
                <span class="mx-2 opacity-50">|</span>
                <span class="small" id="clock-wib">--:-- WIB</span>
            </div>
        </div>
    </nav>

    <div class="container">
        
        <!-- TABS MENU -->
        <ul class="nav nav-pills nav-fill mb-5" id="mainTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="crm-tab" data-bs-toggle="pill" data-bs-target="#crm-content" type="button">
                    <i class="fas fa-rocket me-2"></i>CRM & Blast Ops
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="logs-tab" data-bs-toggle="pill" data-bs-target="#logs-content" type="button">
                    <i class="fas fa-list-ul me-2"></i>Live Logs (Lengkap)
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="targets-tab" data-bs-toggle="pill" data-bs-target="#targets-content" type="button">
                    <i class="fas fa-bullseye me-2"></i>Target & Scanner
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="schedule-tab" data-bs-toggle="pill" data-bs-target="#schedule-content" type="button">
                    <i class="fas fa-calendar-alt me-2"></i>Penjadwalan
                </button>
            </li>
        </ul>

        <!-- TABS CONTENT -->
        <div class="tab-content" id="mainTabContent">

            <!-- ======================= TAB 1: CRM & BLAST OPS ======================= -->
            <div class="tab-pane fade show active" id="crm-content">
                <div class="row g-4">
                    
                    <!-- LEFT COLUMN: STATS & IMPORT -->
                    <div class="col-lg-4">
                        <!-- Stat Card -->
                        <div class="card-custom mb-4 text-white" style="background: var(--primary-gradient); border: none;">
                            <div class="card-body-custom text-center">
                                <div class="mb-2 opacity-75 text-uppercase" style="font-size: 0.75rem; letter-spacing: 1px;">Total Database User</div>
                                <h1 class="display-3 fw-bold mb-0">{{ user_count }}</h1>
                                <div class="mt-2 badge bg-white bg-opacity-20 rounded-pill px-3">Pelanggan Potensial</div>
                            </div>
                        </div>

                        <!-- Import Card -->
                        <div class="card-custom mb-4">
                            <div class="card-body-custom text-center">
                                <div class="mb-3">
                                    <div class="bg-info bg-opacity-10 text-info d-inline-flex p-3 rounded-circle mb-2">
                                        <i class="fas fa-cloud-download-alt fa-2x"></i>
                                    </div>
                                    <h5 class="fw-bold">Import Riwayat Chat</h5>
                                    <p class="text-muted small">Scan pesan pribadi (DM) lama untuk menambah database CRM Anda.</p>
                                </div>
                                <button onclick="importCRM()" class="btn btn-outline-primary w-100 rounded-pill fw-bold">
                                    <i class="fas fa-sync me-2"></i>Mulai Import
                                </button>
                            </div>
                        </div>

                        <!-- Guide Card -->
                        <div class="card-custom">
                            <div class="card-header-custom">
                                <span><i class="fas fa-info-circle me-2 text-primary"></i>Panduan</span>
                            </div>
                            <div class="card-body-custom pt-0">
                                <div class="accordion accordion-flush" id="faqAccordion">
                                    <div class="accordion-item bg-transparent">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed bg-transparent shadow-none px-0" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                                                <small class="fw-bold">Apa bedanya Blast & Broadcast?</small>
                                            </button>
                                        </h2>
                                        <div id="faq1" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                            <div class="accordion-body px-0 text-muted small">
                                                <strong>Blast:</strong> Mengirim pesan ke Grup/Forum yang ditargetkan.<br><br>
                                                <strong>Broadcast:</strong> Mengirim pesan personal (PM) ke user di database CRM.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN: OPERATIONS CENTER -->
                    <div class="col-lg-8">
                        
                        <!-- 1. BLAST CONTROL CENTER (NEW FEATURE) -->
                        <div class="card-custom mb-4 border-start border-4 border-primary">
                            <div class="card-header-custom bg-white">
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary text-white p-2 rounded me-3">
                                        <i class="fas fa-satellite-dish"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-0 fw-bold">Blast Operations Center</h5>
                                        <small class="text-muted">Kontrol pengiriman pesan ke Grup/Forum</small>
                                    </div>
                                </div>
                                <div id="blastStatusBadge">
                                    <span class="status-badge badge-idle">IDLE</span>
                                </div>
                            </div>
                            <div class="card-body-custom">
                                <!-- Progress Info -->
                                <div class="row mb-3 align-items-end">
                                    <div class="col-md-6">
                                        <label class="small text-muted fw-bold mb-1">TARGET SAAT INI</label>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-users text-primary me-2"></i>
                                            <span id="currentGroupTarget" class="fw-bold text-dark text-truncate">Menunggu antrian...</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6 text-md-end mt-3 mt-md-0">
                                        <div class="d-flex justify-content-md-end gap-3">
                                            <div class="text-center">
                                                <div class="h4 fw-bold text-success mb-0" id="successCount">0</div>
                                                <div class="small text-muted" style="font-size: 0.65rem;">SUKSES</div>
                                            </div>
                                            <div class="text-center border-start ps-3">
                                                <div class="h4 fw-bold text-danger mb-0" id="failCount">0</div>
                                                <div class="small text-muted" style="font-size: 0.65rem;">GAGAL</div>
                                            </div>
                                            <div class="text-center border-start ps-3">
                                                <div class="h4 fw-bold text-dark mb-0" id="totalTargets">0</div>
                                                <div class="small text-muted" style="font-size: 0.65rem;">TOTAL</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Progress Bar -->
                                <div class="mb-4">
                                    <div class="d-flex justify-content-between small mb-1">
                                        <span class="text-muted">Progress Keseluruhan</span>
                                        <span class="fw-bold text-primary" id="progressPercentage">0%</span>
                                    </div>
                                    <div class="progress progress-custom">
                                        <div id="blastProgressBar" class="progress-bar progress-bar-animated-custom" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>

                                <!-- Control Buttons -->
                                <div class="d-grid gap-2 d-md-flex">
                                    <button onclick="controlBlast('start')" class="btn btn-primary-gradient btn-custom flex-grow-1">
                                        <i class="fas fa-play me-2"></i>START / RESUME
                                    </button>
                                    <button onclick="controlBlast('pause')" class="btn btn-warning btn-custom text-dark flex-grow-1" style="background: #fde047; border:none;">
                                        <i class="fas fa-pause me-2"></i>PAUSE
                                    </button>
                                    <button onclick="confirmStopBlast()" class="btn btn-danger-gradient btn-custom flex-grow-1">
                                        <i class="fas fa-stop me-2"></i>STOP
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 2. BROADCAST (CRM) SECTION -->
                        <div class="card-custom">
                            <div class="card-header-custom">
                                <span><i class="fas fa-paper-plane me-2 text-success"></i>Broadcast / Follow Up (Personal)</span>
                            </div>
                            <div class="card-body-custom">
                                {% if broadcast_running %}
                                <div class="alert alert-warning border-0 shadow-sm d-flex align-items-center p-4">
                                    <div class="spinner-border text-warning me-3" role="status"></div>
                                    <div>
                                        <h5 class="alert-heading fw-bold mb-1">Broadcast Sedang Berjalan!</h5>
                                        <p class="mb-0 small opacity-75">Sistem sedang mengirim pesan personal secara bertahap. Harap tunggu.</p>
                                    </div>
                                </div>
                                {% else %}
                                <form id="broadcastForm">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold text-secondary small text-uppercase">Isi Pesan</label>
                                        <div class="position-relative">
                                            <textarea class="form-control bg-light border-0 py-3 px-3" name="message" rows="5" placeholder="Halo {name}, mau info promo spesial nih..." style="resize: none; border-radius: 12px;" required></textarea>
                                            <div class="position-absolute bottom-0 end-0 p-2">
                                                <small class="badge bg-white text-secondary shadow-sm border">Markdown Supported</small>
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-between mt-2">
                                            <small class="text-muted"><i class="fas fa-code me-1"></i>Gunakan <code>{name}</code> untuk nama user.</small>
                                            <small class="text-success"><i class="fas fa-shield-alt me-1"></i>Safe Mode Active</small>
                                        </div>
                                    </div>
                                    <button type="button" onclick="startBroadcast()" class="btn btn-success-gradient btn-custom w-100">
                                        <i class="fas fa-share me-2"></i>Kirim Broadcast Sekarang
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- ======================= TAB 2: LIVE LOGS (MAXIMIZED UPGRADE) ======================= -->
            <div class="tab-pane fade" id="logs-content">
                
                <!-- Log Stats Summary (NEW) -->
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="bg-white p-3 rounded-xl shadow-sm border-start border-4 border-primary d-flex align-items-center">
                            <div class="bg-primary bg-opacity-10 p-3 rounded-circle me-3">
                                <i class="fas fa-server text-primary"></i>
                            </div>
                            <div>
                                <h3 class="mb-0 fw-bold" id="log-total">0</h3>
                                <small class="text-muted">Total Aktivitas</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="bg-white p-3 rounded-xl shadow-sm border-start border-4 border-success d-flex align-items-center">
                            <div class="bg-success bg-opacity-10 p-3 rounded-circle me-3">
                                <i class="fas fa-check-double text-success"></i>
                            </div>
                            <div>
                                <h3 class="mb-0 fw-bold" id="log-success">0</h3>
                                <small class="text-muted">Berhasil Terkirim</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="bg-white p-3 rounded-xl shadow-sm border-start border-4 border-danger d-flex align-items-center">
                            <div class="bg-danger bg-opacity-10 p-3 rounded-circle me-3">
                                <i class="fas fa-exclamation-triangle text-danger"></i>
                            </div>
                            <div>
                                <h3 class="mb-0 fw-bold" id="log-failed">0</h3>
                                <small class="text-muted">Gagal / Error</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-custom h-100">
                    <div class="card-header-custom d-flex flex-column flex-md-row align-items-md-center gap-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-history me-2 text-primary"></i>
                            <span>Live Logs System</span>
                        </div>
                        
                        <!-- Advanced Toolbar (NEW) -->
                        <div class="d-flex gap-2 ms-md-auto w-100 w-md-auto">
                            <!-- Search -->
                            <div class="input-group input-group-sm w-auto">
                                <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                                <input type="text" id="logSearchInput" class="form-control border-start-0" placeholder="Cari Log..." onkeyup="renderLogTable()">
                            </div>
                            
                            <!-- Status Filter -->
                            <select id="logStatusFilter" class="form-select form-select-sm w-auto" onchange="renderLogTable()">
                                <option value="ALL">Semua Status</option>
                                <option value="SUCCESS">Hanya Sukses</option>
                                <option value="FAILED">Hanya Gagal</option>
                                <option value="WAIT">Menunggu (Flood)</option>
                            </select>

                            <!-- Refresh -->
                            <button onclick="location.reload()" class="btn btn-sm btn-light border" title="Refresh Data">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Enhanced Table -->
                    <div class="card-body-custom p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0 table-custom" id="logTableFull">
                                <thead class="bg-light text-secondary small text-uppercase sticky-top">
                                    <tr>
                                        <th class="ps-4 py-3" onclick="sortLogTable('time')">Waktu <i class="fas fa-sort ms-1 opacity-50"></i></th>
                                        <th class="py-3" onclick="sortLogTable('group')">Target Group <i class="fas fa-sort ms-1 opacity-50"></i></th>
                                        <th class="py-3">Topic ID</th>
                                        <th class="py-3">Status</th>
                                        <th class="py-3 text-end pe-4">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="logTableBody">
                                    <!-- Data injected via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Pagination Footer (NEW) -->
                    <div class="card-footer bg-white border-top p-3">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <div class="d-flex align-items-center gap-2">
                                <small class="text-muted">Baris per halaman:</small>
                                <select id="rowsPerPage" class="form-select form-select-sm w-auto" onchange="changeRowsPerPage()">
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                                <small class="text-muted ms-2" id="showingInfo">Menampilkan 0 - 0 dari 0 data</small>
                            </div>
                            
                            <nav aria-label="Log navigation">
                                <ul class="pagination pagination-sm pagination-custom mb-0" id="paginationControls">
                                    <!-- Pagination buttons will be generated here -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ======================= TAB 3: TARGET & SCANNER ======================= -->
            <div class="tab-pane fade" id="targets-content">
                <div class="row g-4">
                    <!-- LIST TARGET -->
                    <div class="col-lg-5">
                        <div class="card-custom h-100">
                            <div class="card-header-custom text-success">
                                <span><i class="fas fa-database me-2"></i>Database Target</span>
                                <span class="badge bg-success rounded-pill">{{ targets|length }} Active</span>
                            </div>
                            <div class="card-body-custom p-0" style="max-height: 600px; overflow-y: auto;">
                                <ul class="list-group list-group-flush">
                                    {% for target in targets %}
                                    <li class="list-group-item p-3 border-bottom-0 border-top">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="overflow-hidden me-3">
                                                <h6 class="mb-1 fw-bold text-dark text-truncate">{{ target.group_name }}</h6>
                                                <div class="small text-muted mb-2 font-monospace">{{ target.group_id }}</div>
                                                <div class="d-flex flex-wrap gap-1">
                                                    {% if target.topic_ids %}
                                                        {% for t in target.topic_ids.split(',') %}
                                                        <span class="badge bg-light text-dark border small">{{ t }}</span>
                                                        {% endfor %}
                                                    {% else %}
                                                        <span class="badge bg-light text-muted border small">General</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <button onclick="confirmDeleteTarget('{{ target.id }}', '{{ target.group_name }}')" class="btn btn-sm btn-outline-danger btn-action-icon rounded-circle shadow-sm">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </li>
                                    {% else %}
                                    <li class="list-group-item text-center py-5 border-0">
                                        <i class="fas fa-folder-open fa-3x mb-3 text-muted opacity-25"></i>
                                        <p class="text-muted">Database target kosong.<br>Lakukan scan di sebelah kanan.</p>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- SCANNER -->
                    <div class="col-lg-7">
                        <div class="card-custom border-primary border-2 h-100">
                            <div class="card-header-custom bg-primary bg-opacity-10 text-primary">
                                <span><i class="fas fa-radar me-2"></i>Telegram Scanner</span>
                                <button onclick="saveSelection()" class="btn btn-sm btn-primary shadow-sm fw-bold">
                                    <i class="fas fa-save me-1"></i> Simpan Pilihan
                                </button>
                            </div>
                            <div class="card-body-custom bg-light">
                                <div class="text-center mb-4">
                                    <button onclick="scanTelegram()" class="btn btn-primary-gradient btn-lg rounded-pill px-5 shadow-lg animate__animated animate__pulse animate__infinite infinite">
                                        <i class="fas fa-search-location me-2"></i>Scan Grup Terbaru
                                    </button>
                                    <p class="text-muted small mt-2">Bot akan membaca seluruh grup & forum yang Anda ikuti.</p>
                                </div>

                                <!-- Search Filter -->
                                <div class="input-group mb-3 shadow-sm">
                                    <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                                    <input type="text" id="scanFilter" class="form-control border-start-0 ps-0" placeholder="Cari nama grup..." onkeyup="filterScanResults()">
                                </div>

                                <!-- Scan Results Area -->
                                <div id="scan-results-area" class="bg-white rounded-3 shadow-sm border p-2" style="height: 400px; overflow-y: auto;">
                                    <div class="h-100 d-flex flex-column align-items-center justify-content-center text-muted opacity-50">
                                        <i class="fab fa-telegram fa-4x mb-3"></i>
                                        <p>Hasil scan akan muncul di sini</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ======================= TAB 4: SCHEDULE ======================= -->
            <div class="tab-pane fade" id="schedule-content">
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="card-custom">
                            <div class="card-header-custom text-primary">
                                <span><i class="fas fa-plus-circle me-2"></i>Buat Jadwal</span>
                            </div>
                            <div class="card-body-custom">
                                <form action="/add_schedule" method="POST">
                                    <div class="row g-2 mb-3">
                                        <div class="col-6">
                                            <label class="form-label small fw-bold text-uppercase">Jam</label>
                                            <input type="number" name="hour" class="form-control form-control-lg text-center fw-bold" placeholder="00" required min="0" max="23">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label small fw-bold text-uppercase">Menit</label>
                                            <input type="number" name="minute" class="form-control form-control-lg text-center fw-bold" value="00" min="0" max="59">
                                        </div>
                                    </div>
                                    <div class="alert alert-info py-2 small mb-3">
                                        <i class="fas fa-clock me-1"></i> Waktu Server: WIB (UTC+7)
                                    </div>
                                    <button type="submit" class="btn btn-primary-gradient w-100 btn-custom">Simpan Jadwal</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card-custom">
                            <div class="card-header-custom">
                                <span><i class="fas fa-calendar-check me-2 text-secondary"></i>Daftar Jadwal Aktif</span>
                            </div>
                            <div class="card-body-custom">
                                <div class="row g-3">
                                    {% for s in schedules %}
                                    <div class="col-6 col-md-3">
                                        <div class="position-relative border bg-white rounded-3 p-3 text-center shadow-sm h-100 d-flex flex-column justify-content-center align-items-center">
                                            <h2 class="mb-0 fw-bold text-dark font-monospace">{{ '%02d' % s.run_hour }}:{{ '%02d' % s.run_minute }}</h2>
                                            <span class="badge bg-light text-secondary border mt-2">WIB</span>
                                            <a href="/delete_schedule/{{ s.id }}" class="position-absolute top-0 end-0 m-2 text-danger opacity-50 hover-opacity-100 transition" onclick="return confirm('Hapus jadwal ini?')">
                                                <i class="fas fa-times-circle"></i>
                                            </a>
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="col-12 text-center py-5">
                                        <i class="far fa-calendar-times fa-3x mb-3 text-muted opacity-25"></i>
                                        <p class="text-muted">Belum ada jadwal otomatis yang diatur.</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div> <!-- End Tab Content -->
    </div> <!-- End Container -->

    <!-- STOP CONFIRMATION MODAL -->
    <div class="modal fade" id="stopConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 16px; overflow: hidden;">
                <div class="modal-header bg-danger text-white border-0">
                    <h5 class="modal-title fw-bold"><i class="fas fa-exclamation-triangle me-2"></i>Konfirmasi Stop</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4 text-center">
                    <p class="mb-0 fs-5">Apakah Anda yakin ingin menghentikan paksa proses Blast?</p>
                    <p class="text-muted small mt-2">Proses akan berhenti total dan progress saat ini akan di-reset.</p>
                </div>
                <div class="modal-footer border-0 bg-light justify-content-center pb-4">
                    <button type="button" class="btn btn-light px-4 rounded-pill" data-bs-dismiss="modal">Batal</button>
                    <button type="button" onclick="executeStop()" class="btn btn-danger px-4 rounded-pill fw-bold">Ya, Hentikan!</button>
                </div>
            </div>
        </div>
    </div>

    <!-- LOG DETAIL MODAL (NEW) -->
    <div class="modal fade" id="logDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Detail Log</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="fw-bold small text-muted">Status</label>
                        <div id="modalLogStatus"></div>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold small text-muted">Target</label>
                        <div class="p-2 bg-light rounded" id="modalLogTarget"></div>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold small text-muted">Pesan Error / Info Lengkap</label>
                        <pre class="bg-dark text-light p-3 rounded" style="white-space: pre-wrap;" id="modalLogMessage"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BOOTSTRAP JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- CLOCK WIDGET ---
        setInterval(() => {
            const now = new Date();
            const timeString = now.toLocaleTimeString('id-ID', { timeZone: 'Asia/Jakarta', hour: '2-digit', minute: '2-digit' });
            document.getElementById('clock-wib').textContent = timeString + " WIB";
        }, 1000);

        // --- GLOBAL VARS ---
        let scannedData = [];
        let blastStatusInterval = null;

        // --- LOG SYSTEM VARIABLES (NEW) ---
        // Inject data from Flask to JS safely
        const rawLogs = {{ logs | tojson | safe }}; 
        let currentLogs = rawLogs; // Untuk filter
        let currentPage = 1;
        let rowsPerPage = 10;
        let sortDirection = 'desc';

        // --- TOAST NOTIFICATION ---
        function showToast(message, type = 'success') {
            const container = document.querySelector('.toast-container');
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            const color = type === 'success' ? 'success' : 'danger';
            
            const html = `
                <div class="toast align-items-center text-white bg-${color} border-0 animate__animated animate__fadeInRight" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body fw-bold d-flex align-items-center">
                            <i class="fas ${icon} me-2 fa-lg"></i> ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            const el = document.createElement('div');
            el.innerHTML = html;
            container.appendChild(el.firstElementChild);
            
            const toastEl = container.lastElementChild;
            const toast = new bootstrap.Toast(toastEl, { delay: 4000 });
            toast.show();
            
            toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
        }

        // --- LOADER HELPER ---
        function toggleLoader(show) {
            document.getElementById('globalLoader').style.display = show ? 'flex' : 'none';
        }

        // --- BLAST CONTROL LOGIC ---
        function updateBlastUI(data) {
            const badgeEl = document.getElementById('blastStatusBadge');
            const statusMap = {
                'IDLE': { class: 'badge-idle', icon: 'fa-stop-circle', text: 'IDLE / READY' },
                'RUNNING': { class: 'badge-running', icon: 'fa-sync fa-spin', text: 'RUNNING' },
                'PAUSED': { class: 'badge-paused', icon: 'fa-pause-circle', text: 'PAUSED' },
                'STOPPED': { class: 'badge-stopped', icon: 'fa-ban', text: 'STOPPED' }
            };
            
            const state = data.state;
            const conf = statusMap[state] || statusMap['IDLE'];
            
            // Update Badge
            badgeEl.innerHTML = `<span class="status-badge ${conf.class}"><i class="fas ${conf.icon} me-1"></i>${conf.text}</span>`;
            
            // Update Stats
            const meta = data.meta;
            document.getElementById('currentGroupTarget').textContent = state === 'IDLE' ? 'Menunggu antrian...' : (meta.current_group || '-');
            document.getElementById('successCount').textContent = meta.success_count;
            document.getElementById('failCount').textContent = meta.fail_count;
            document.getElementById('totalTargets').textContent = meta.total_targets;
            
            // Update Progress Bar
            let percent = 0;
            if(meta.total_targets > 0) {
                percent = Math.round((meta.current_index / meta.total_targets) * 100);
            }
            document.getElementById('blastProgressBar').style.width = percent + '%';
            document.getElementById('progressPercentage').textContent = percent + '%';
        }

        function fetchBlastStatus() {
            fetch('/api/blast/status')
                .then(r => r.json())
                .then(data => updateBlastUI(data))
                .catch(e => console.error("Status polling error:", e));
        }

        function controlBlast(action) {
            fetch('/api/blast/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: action})
            })
            .then(r => r.json())
            .then(json => {
                if(json.status === 'success') {
                    showToast(json.message, 'success');
                    fetchBlastStatus(); // Instant update
                } else {
                    showToast(json.message, 'error');
                }
            });
        }

        // Stop Confirmation
        let stopModal;
        function confirmStopBlast() {
            stopModal = new bootstrap.Modal(document.getElementById('stopConfirmModal'));
            stopModal.show();
        }
        function executeStop() {
            controlBlast('stop');
            stopModal.hide();
        }

        // Start Polling on Load
        setInterval(fetchBlastStatus, 2000); // Poll every 2 seconds
        fetchBlastStatus(); // Initial call

        // ==========================================
        //  LOGS SYSTEM LOGIC (NEW & ENHANCED)
        // ==========================================
        
        function initLogSystem() {
            // Calculate Stats
            let success = rawLogs.filter(l => l.status.includes('SUCCESS')).length;
            let failed = rawLogs.filter(l => l.status.includes('FAILED') || l.status.includes('FLOOD')).length;
            
            document.getElementById('log-total').innerText = rawLogs.length;
            document.getElementById('log-success').innerText = success;
            document.getElementById('log-failed').innerText = failed;

            renderLogTable();
        }

        function changeRowsPerPage() {
            rowsPerPage = parseInt(document.getElementById('rowsPerPage').value);
            currentPage = 1;
            renderLogTable();
        }

        function sortLogTable(key) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            // Logic sort sederhana
            if (key === 'time') {
                currentLogs.sort((a, b) => {
                    return sortDirection === 'asc' ? 
                        new Date(a.created_at) - new Date(b.created_at) : 
                        new Date(b.created_at) - new Date(a.created_at);
                });
            } else if (key === 'group') {
                currentLogs.sort((a, b) => {
                    return sortDirection === 'asc' ? 
                        a.group_name.localeCompare(b.group_name) : 
                        b.group_name.localeCompare(a.group_name);
                });
            }
            renderLogTable(false); // false = jangan reset filter
        }

        function renderLogTable(resetFilter = true) {
            const tbody = document.getElementById('logTableBody');
            const searchVal = document.getElementById('logSearchInput').value.toLowerCase();
            const statusFilter = document.getElementById('logStatusFilter').value;

            // 1. FILTERING
            if (resetFilter) {
                currentLogs = rawLogs.filter(log => {
                    const matchesSearch = log.group_name.toLowerCase().includes(searchVal) || 
                                          (log.error_message && log.error_message.toLowerCase().includes(searchVal));
                    const matchesStatus = statusFilter === 'ALL' || log.status.includes(statusFilter);
                    return matchesSearch && matchesStatus;
                });
            }

            // 2. PAGINATION LOGIC
            const totalItems = currentLogs.length;
            const totalPages = Math.ceil(totalItems / rowsPerPage);
            if (currentPage > totalPages) currentPage = totalPages || 1;

            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, totalItems);
            const displayLogs = currentLogs.slice(startIndex, endIndex);

            // 3. RENDER TABLE ROWS
            let html = '';
            if (displayLogs.length === 0) {
                html = `<tr><td colspan="5" class="text-center py-5 text-muted"><i class="fas fa-search me-2"></i>Data tidak ditemukan</td></tr>`;
            } else {
                displayLogs.forEach(log => {
                    // Badge Styling
                    let badgeClass = 'bg-secondary';
                    let iconClass = 'fa-question';
                    if (log.status.includes('SUCCESS')) { badgeClass = 'bg-success bg-opacity-10 text-success'; iconClass = 'fa-check'; }
                    else if (log.status.includes('RETRY')) { badgeClass = 'bg-warning bg-opacity-10 text-warning'; iconClass = 'fa-redo'; }
                    else if (log.status.includes('FLOOD') || log.status.includes('WAIT')) { badgeClass = 'bg-info bg-opacity-10 text-info'; iconClass = 'fa-clock'; }
                    else { badgeClass = 'bg-danger bg-opacity-10 text-danger'; iconClass = 'fa-times'; }

                    // Safe Message
                    const safeMsg = (log.error_message || '').replace(/"/g, '&quot;');
                    const shortMsg = safeMsg.length > 50 ? safeMsg.substring(0, 50) + '...' : (safeMsg || 'OK');

                    html += `
                        <tr class="border-bottom-0">
                            <td class="ps-4">
                                <div class="fw-bold text-dark">${log.created_at.substring(11, 19)}</div>
                                <div class="small text-muted" style="font-size:0.7rem">${log.created_at.substring(0, 10)}</div>
                            </td>
                            <td class="fw-bold text-primary text-truncate" style="max-width: 200px;">${log.group_name}</td>
                            <td>
                                ${log.topic_id ? `<span class="badge bg-light text-dark border font-monospace">${log.topic_id}</span>` : '<span class="text-muted">-</span>'}
                            </td>
                            <td>
                                <span class="badge ${badgeClass} rounded-pill px-3 py-2"><i class="fas ${iconClass} me-1"></i>${log.status}</span>
                            </td>
                            <td class="text-end pe-4">
                                <button class="btn btn-sm btn-outline-secondary" onclick="viewLogDetail('${log.status}', '${log.group_name}', '${safeMsg.replace(/\n/g, ' ')}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }
            tbody.innerHTML = html;

            // 4. RENDER PAGINATION CONTROLS
            document.getElementById('showingInfo').innerText = `Menampilkan ${totalItems > 0 ? startIndex + 1 : 0} - ${endIndex} dari ${totalItems} data`;
            
            let pageHtml = '';
            // Prev
            pageHtml += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <button class="page-link" onclick="goToPage(${currentPage - 1})"><i class="fas fa-chevron-left"></i></button>
            </li>`;
            
            // Page Numbers (Simple logic for now)
            for(let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    pageHtml += `<li class="page-item"><button class="page-link ${currentPage === i ? 'active' : ''}" onclick="goToPage(${i})">${i}</button></li>`;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    pageHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            // Next
            pageHtml += `<li class="page-item ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}">
                <button class="page-link" onclick="goToPage(${currentPage + 1})"><i class="fas fa-chevron-right"></i></button>
            </li>`;
            
            document.getElementById('paginationControls').innerHTML = pageHtml;
        }

        function goToPage(page) {
            currentPage = page;
            renderLogTable(false);
        }

        function viewLogDetail(status, group, msg) {
            document.getElementById('modalLogStatus').innerText = status;
            document.getElementById('modalLogTarget').innerText = group;
            document.getElementById('modalLogMessage').innerText = msg || 'Tidak ada pesan error.';
            new bootstrap.Modal(document.getElementById('logDetailModal')).show();
        }

        // Init Logs on Load
        document.addEventListener('DOMContentLoaded', initLogSystem);


        // --- SCANNER LOGIC ---
        function scanTelegram() {
            toggleLoader(true);
            const resultArea = document.getElementById('scan-results-area');
            
            fetch('/scan_groups_api')
                .then(response => response.json())
                .then(json => {
                    toggleLoader(false);
                    if(json.status === 'success') {
                        renderScanResults(json.data);
                    } else {
                        resultArea.innerHTML = `<div class="text-danger text-center p-3"><i class="fas fa-exclamation-triangle"></i> Gagal Scan: ${json.message}</div>`;
                    }
                })
                .catch(err => {
                    toggleLoader(false);
                    resultArea.innerHTML = `<div class="text-danger text-center p-3">Error Koneksi: ${err}</div>`;
                });
        }

        function renderScanResults(data) {
            scannedData = data;
            const container = document.getElementById('scan-results-area');
            
            if (data.length === 0) {
                container.innerHTML = '<div class="text-center py-5 text-muted">Tidak ditemukan grup.</div>';
                return;
            }

            let html = '<div class="list-group list-group-flush">';
            data.forEach((group, index) => {
                const hasTopics = group.is_forum && group.topics && group.topics.length > 0;
                
                html += `
                <div class="list-group-item px-2 py-3 border-bottom group-item" data-name="${group.name.toLowerCase()}">
                    <div class="d-flex align-items-center">
                        <div class="form-check me-2">
                            <input class="form-check-input" type="checkbox" style="transform: scale(1.2);" id="g-${index}" value="${index}" onchange="toggleTopics(${index})">
                        </div>
                        <div class="flex-grow-1">
                            <label class="form-check-label fw-bold text-dark d-block pointer" for="g-${index}">
                                ${group.name}
                            </label>
                            <small class="text-muted d-flex align-items-center">
                                <i class="fas fa-fingerprint me-1"></i> ${group.id}
                                ${group.is_forum ? '<span class="badge bg-warning text-dark ms-2" style="font-size:0.6rem">FORUM</span>' : ''}
                            </small>
                        </div>
                    </div>
                    
                    <div class="mt-2 ms-4 bg-light p-2 rounded">
                         <div class="input-group input-group-sm">
                            <span class="input-group-text border-0 bg-transparent text-muted">Manual ID:</span>
                            <input type="text" class="form-control border-0 bg-white shadow-sm rounded" id="manual-topic-${index}" placeholder="Contoh: 123, 456">
                        </div>
                    </div>

                    ${group.is_forum ? `
                        <div class="ms-4 mt-2" id="topics-${index}">
                            ${hasTopics ? `
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="fw-bold text-secondary" style="font-size:0.7rem">TOPICS DETECTED:</small>
                                    <small class="text-primary pointer" style="font-size:0.7rem" onclick="toggleTopics(${index}, true)">Select All</small>
                                </div>
                                <div class="row g-2">
                                    ${group.topics.map(t => `
                                        <div class="col-12">
                                            <div class="form-check bg-white border rounded px-3 py-1 shadow-sm">
                                                <input class="form-check-input topic-check-${index}" type="checkbox" value="${t.id}" id="t-${t.id}">
                                                <label class="form-check-label w-100 small pointer" for="t-${t.id}">
                                                    ${t.title} <span class="text-muted ms-1">(${t.id})</span>
                                                </label>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `<small class="text-danger fst-italic ms-1">No automated topics found. Use Manual ID.</small>`}
                        </div>
                    ` : ''}
                </div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function filterScanResults() {
            const term = document.getElementById('scanFilter').value.toLowerCase();
            document.querySelectorAll('.group-item').forEach(el => {
                const name = el.getAttribute('data-name');
                el.style.display = name.includes(term) ? 'block' : 'none';
            });
        }

        function toggleTopics(index, forceAll = false) {
            const groupCheck = document.getElementById(`g-${index}`);
            if (forceAll) groupCheck.checked = true;
            document.querySelectorAll(`.topic-check-${index}`).forEach(cb => {
                cb.checked = groupCheck.checked;
            });
        }

        function saveSelection() {
            const selected = [];
            scannedData.forEach((group, index) => {
                const groupCheck = document.getElementById(`g-${index}`);
                const manualInput = document.getElementById(`manual-topic-${index}`);
                const topicChecks = document.querySelectorAll(`.topic-check-${index}:checked`);
                
                let selectedTopicIds = [];
                topicChecks.forEach(cb => selectedTopicIds.push(cb.value));

                if (manualInput && manualInput.value.trim() !== "") {
                    manualInput.value.split(',').forEach(m => {
                        if(m.trim()) selectedTopicIds.push(m.trim());
                    });
                }

                if (groupCheck && (groupCheck.checked || selectedTopicIds.length > 0)) {
                    selected.push({
                        group_id: group.id,
                        group_name: group.name,
                        topic_ids: selectedTopicIds
                    });
                }
            });

            if (selected.length === 0) return showToast("Pilih minimal satu grup!", 'error');

            toggleLoader(true);
            fetch('/save_bulk_targets', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({targets: selected})
            })
            .then(res => res.json())
            .then(json => {
                toggleLoader(false);
                if(json.status === 'success') {
                    showToast(json.message, 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(json.message, 'error');
                }
            });
        }

        // --- BROADCAST FUNCTION ---
        function startBroadcast() {
            const form = document.getElementById('broadcastForm');
            const formData = new FormData(form);
            
            if(!formData.get('message')) return showToast("Pesan tidak boleh kosong!", 'error');
            
            if(confirm(" Mulai Broadcast ke SEMUA user di database?")) {
                toggleLoader(true);
                fetch('/start_broadcast', { method: 'POST', body: formData })
                .then(r => r.json()).then(json => {
                    toggleLoader(false);
                    if(json.status === 'success') {
                        showToast(json.message, 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showToast(json.message, 'error');
                    }
                });
            }
        }

        // --- IMPORT CRM ---
        function importCRM() {
            if(confirm(" Import chat history? Proses ini akan berjalan di background.")) {
                toggleLoader(true);
                fetch('/import_crm_api', { method: 'POST' })
                .then(r => r.json()).then(json => {
                    toggleLoader(false);
                    showToast(json.message, json.status === 'success' ? 'success' : 'error');
                });
            }
        }

        // --- DELETE TARGET ---
        function confirmDeleteTarget(id, name) {
            if(confirm(`Hapus target: ${name}?`)) {
                window.location.href = `/delete_target/${id}`;
            }
        }
    </script>
</body>
</html>
